<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定時炸彈遊戲 (優化版)</title>
    <style>
        /* --- 頁面整體樣式 --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f8ff;
            color: #333;
            text-align: center;
            padding: 1em;
        }

        /* --- 遊戲主容器 --- */
        .game-container {
            background-color: #ffffff;
            padding: 2em;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            margin: 1em auto;
        }

        h1 { color: #d9534f; }
        h3, h4 { color: #5bc0de; }

        /* --- 計時器顯示 --- */
        #timer-display {
            font-size: 5rem;
            font-weight: bold;
            color: #4CAF50;
            margin: 0.2em 0;
            letter-spacing: 5px;
            transition: color 0.5s;
        }

        @keyframes blinking-text {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        .blinking-text {
            color: #d9534f !important;
            animation: blinking-text 1s infinite;
        }

        /* --- 按鈕和輸入框樣式 --- */
        input[type="number"], input[type="text"], select, button {
            padding: 10px;
            font-size: 1em;
            border: 2px solid #ccc;
            border-radius: 8px;
            margin: 5px;
            vertical-align: middle;
        }
        button {
            background-color: #5bc0de;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        button:hover {
            background-color: #31b0d5;
            transform: scale(1.05);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        #start-btn { background-color: #4CAF50; }
        #start-btn:hover:enabled { background-color: #45a049; }

        /* --- 區域劃分 --- */
        .area-section {
            margin: 1.5em 0;
            padding: 1em 0;
            border-top: 1px solid #eee;
        }
        .hidden { display: none; }

        /* --- 狀態訊息 --- */
        #status-message {
            font-size: 2em;
            font-weight: bold;
            color: #d9534f;
            min-height: 50px;
        }

        /* --- 玩家列表樣式 --- */
        #player-list {
            list-style-type: none; padding: 0; max-width: 400px; margin: 0 auto;
        }
        #player-list li {
            background-color: #f9f9f9; padding: 8px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;
        }
        .remove-player-btn {
            background-color: #d9534f; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-weight: bold; cursor: pointer; line-height: 25px; padding: 0;
        }
        
        /* --- 歷史紀錄列表樣式 --- */
        #history-list {
            list-style-type: decimal; padding-left: 30px; text-align: left; max-width: 300px; margin: 1em auto;
        }
        #history-list .count {
            font-weight: bold; color: #d9534f; margin-left: 10px;
        }

        /* --- 結束後顯示的內容樣式 --- */
        #punishment-area {
            background-color: #fffbe6; border: 2px solid #f0ad4e; border-radius: 10px; padding: 15px; margin-top: 20px; text-align: left; line-height: 1.8;
        }
        #punishment-area .player-name {
            font-weight: bold; font-size: 1.5em; color: #d9534f; display: block; text-align: center; margin-bottom: 10px;
        }

        /* [新功能 2] 讓管理名單按鈕變得低調 */
        .footer-controls {
            text-align: right;
            margin-top: 20px;
        }
        #toggle-players-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 0.9em;
            text-decoration: underline;
            padding: 5px;
            cursor: pointer;
        }
        #toggle-players-btn:hover {
            color: #000;
            background: none;
            transform: none;
        }

    </style>
</head>
<body>

    <div class="game-container">
        <h1>💣 定時炸彈 💣</h1>

        <!-- [新功能 1] 將排行榜移到最上面 -->
        <div id="history-area" class="area-section">
            <h4>📜 被炸到的次數排行榜</h4>
            <ul id="history-list"></ul>
        </div>
        
        <div id="timer-display">01:00</div>
        <div id="status-message"></div>

        <div id="setup-area" class="area-section">
            <label for="time-input">遊戲時間 (秒):</label>
            <input type="number" id="time-input" value="60" min="5">
            <button id="start-btn">開始遊戲</button>
        </div>
        
        <div id="result-area" class="area-section hidden">
            <h3>是誰拿到了炸彈？</h3>
            <select id="player-select"></select>
            <button id="submit-name-btn">記錄姓名</button>
        </div>

        <div id="punishment-area" class="area-section hidden"></div>

        <div id="play-again-area" class="hidden">
             <button id="play-again-btn">再玩一輪！</button>
        </div>
        
        <div id="player-management-area" class="area-section hidden">
            <h4>🎮 玩家管理</h4>
            <div>
                <input type="text" id="new-player-input" placeholder="輸入新玩家姓名">
                <button id="add-player-btn">新增玩家</button>
            </div>
            <ul id="player-list"></ul>
        </div>

        <!-- [新功能 2] 管理名單的觸發按鈕移到最下面 -->
        <div class="footer-controls">
             <button id="toggle-players-btn">管理名單</button>
        </div>

    </div>

    <script>
        // --- 元素抓取 ---
        const timerDisplay = document.getElementById('timer-display');
        const statusMessage = document.getElementById('status-message');
        const timeInput = document.getElementById('time-input');
        const startBtn = document.getElementById('start-btn');
        const playerSelect = document.getElementById('player-select');
        const submitNameBtn = document.getElementById('submit-name-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const newPlayerInput = document.getElementById('new-player-input');
        const addPlayerBtn = document.getElementById('add-player-btn');
        const playerList = document.getElementById('player-list');
        const historyList = document.getElementById('history-list');
        const setupArea = document.getElementById('setup-area');
        const resultArea = document.getElementById('result-area');
        const playAgainArea = document.getElementById('play-again-area');
        const punishmentArea = document.getElementById('punishment-area');
        const togglePlayersBtn = document.getElementById('toggle-players-btn');
        const playerManagementArea = document.getElementById('player-management-area');


        // --- 遊戲變數 ---
        let timer;
        let timeLeft = 0;
        let playerNames = [];
        let historyRecords = {}; 
        const tickSound = new Audio('https://www.soundjay.com/clock/sounds/clock-ticking-1.mp3');
        tickSound.loop = true;
        const explosionSound = new Audio('https://www.soundjay.com/mechanical/sounds/explosion-01.mp3');

        // --- 功能函式 ---

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function startGame() {
            setupArea.classList.add('hidden');
            playAgainArea.classList.add('hidden');
            resultArea.classList.add('hidden');
            punishmentArea.classList.add('hidden');
            statusMessage.textContent = '';
            
            timeLeft = parseInt(timeInput.value, 10) || 60;
            
            timerDisplay.classList.remove('blinking-text');
            timerDisplay.textContent = formatTime(timeLeft);
            
            tickSound.play();

            timer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = formatTime(timeLeft);

                if (timeLeft <= 10) {
                    timerDisplay.classList.add('blinking-text');
                }

                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }
        
        function endGame() {
            clearInterval(timer);
            tickSound.pause();
            tickSound.currentTime = 0;
            explosionSound.play();
            
            statusMessage.textContent = '💥 轟隆！爆炸了！ 💥';
            resultArea.classList.remove('hidden');
        }

        function showPunishment(playerName) {
            punishmentArea.innerHTML = `
                <span class="player-name">${playerName}，請唸出來：</span>
                <p><strong>三字訣：</strong>順從神、服從人。</p>
                <p><strong>七字訣：</strong>信而順從神喜愛、服從權柄不頂撞。</p>
                <p><strong>讀聖經節：</strong>「又要讓基督的平安在你們心裡作仲裁」歌羅西書3:15上</p>
            `;
            punishmentArea.classList.remove('hidden');
        }

        function resetGame() {
            statusMessage.textContent = '';
            timeLeft = parseInt(timeInput.value, 10) || 60;
            timerDisplay.textContent = formatTime(timeLeft);
            timerDisplay.classList.remove('blinking-text');

            playAgainArea.classList.add('hidden');
            punishmentArea.classList.add('hidden');
            setupArea.classList.remove('hidden');
        }

        // --- 玩家管理 ---
        function renderPlayerList() {
            playerList.innerHTML = '';
            playerNames.forEach((name, index) => {
                const li = document.createElement('li');
                li.textContent = name;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'X';
                removeBtn.className = 'remove-player-btn';
                removeBtn.onclick = () => removePlayer(index);
                li.appendChild(removeBtn);
                playerList.appendChild(li);
            });
            populatePlayerSelect();
            savePlayersToLocalStorage();
            updateStartButtonState();
        }

        function addPlayer() {
            const newName = newPlayerInput.value.trim();
            if (newName && !playerNames.includes(newName)) {
                playerNames.push(newName);
                newPlayerInput.value = '';
                renderPlayerList();
            } else if (playerNames.includes(newName)) {
                alert('這個名字已經存在了！');
            }
        }

        function removePlayer(index) {
            const removedPlayer = playerNames[index];
            playerNames.splice(index, 1);
            if (historyRecords[removedPlayer]) {
                delete historyRecords[removedPlayer];
                saveHistoryToLocalStorage();
                renderHistoryList();
            }
            renderPlayerList();
        }

        function populatePlayerSelect() {
            playerSelect.innerHTML = '';
            playerNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                playerSelect.appendChild(option);
            });
        }
        
        function updateStartButtonState() {
            startBtn.disabled = playerNames.length === 0;
            if (startBtn.disabled) {
                statusMessage.textContent = '請先新增玩家才能開始遊戲！';
            } else if (statusMessage.textContent === '請先新增玩家才能開始遊戲！') {
                statusMessage.textContent = '';
            }
        }

        // --- 歷史紀錄與 LocalStorage ---
        function renderHistoryList() {
            historyList.innerHTML = '';
            const sortedRecords = Object.entries(historyRecords).sort(([, countA], [, countB]) => countB - countA);

            sortedRecords.forEach(([name, count]) => {
                const li = document.createElement('li');
                li.innerHTML = `${name} <span class="count">${count} 次</span>`;
                historyList.appendChild(li);
            });
        }
        
        function recordNameAndShowPunishment() {
            const selectedPlayer = playerSelect.value;
            if (!selectedPlayer) {
                alert('請選擇一位玩家！');
                return;
            }
            historyRecords[selectedPlayer] = (historyRecords[selectedPlayer] || 0) + 1;
            
            saveHistoryToLocalStorage();
            renderHistoryList();
            
            resultArea.classList.add('hidden');
            showPunishment(selectedPlayer);
            playAgainArea.classList.remove('hidden');
        }

        function savePlayersToLocalStorage() {
            localStorage.setItem('bombGamePlayers', JSON.stringify(playerNames));
        }

        function saveHistoryToLocalStorage() {
            localStorage.setItem('bombGameHistory', JSON.stringify(historyRecords));
        }

        function loadFromLocalStorage() {
            const storedPlayers = localStorage.getItem('bombGamePlayers');
            const storedHistory = localStorage.getItem('bombGameHistory');
            
            if (storedPlayers) {
                playerNames = JSON.parse(storedPlayers);
            } else {
                playerNames = ['允恩', '允薆', '坤翰', '筠縢', '心恩', '芊妤'];
            }
            
            if (storedHistory) {
                historyRecords = JSON.parse(storedHistory) || {};
            }
        }

        // --- 頁面初始化 ---
        window.onload = () => {
            loadFromLocalStorage();
            renderPlayerList();
            renderHistoryList();
            
            const initialTime = parseInt(timeInput.value, 10);
            timerDisplay.textContent = formatTime(initialTime);

            // --- 事件綁定 ---
            startBtn.addEventListener('click', startGame);
            submitNameBtn.addEventListener('click', recordNameAndShowPunishment);
            playAgainBtn.addEventListener('click', resetGame);
            addPlayerBtn.addEventListener('click', addPlayer);
            newPlayerInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addPlayer();
            });

            togglePlayersBtn.addEventListener('click', () => {
                playerManagementArea.classList.toggle('hidden');
                if (playerManagementArea.classList.contains('hidden')) {
                    togglePlayersBtn.textContent = '管理名單';
                } else {
                    togglePlayersBtn.textContent = '隱藏名單管理';
                }
            });
        };
    </script>
</body>
</html>
